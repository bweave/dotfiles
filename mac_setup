#!/bin/bash

RED="\033[0;31m"
GREEN="\033[0;32m"
BLUE="\033[0;34m"
ENDCOLOR="\033[0m"

function msg() {
  echo -e "$1"
}

function info() {
  msg "$BLUE$1$ENDCOLOR"
}

function success() {
  msg "${GREEN}$1${ENDCOLOR}"
}

function error() {
  msg "${RED}$1${ENDCOLOR}"
}

info "Mac setup - enter your password to get started:"
sudo echo "Let's go!"

# Install brew
if [ ! "$(command -v brew)" ]; then
  info "Installing homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  success "Homebrew is g2g"
else
  success "Homebrew is g2g"
fi

# Install some packages
info "Install Homebrew packages:"
PS3="Select a Brewfile to install: "
select brewfile in personal work
do
  brew bundle --file "$HOME/dotfiles/Brewfile_$brewfile"
  break
done

# Install oh-my-zsh
if [ ! -d "$HOME/.oh-my-zsh" ]; then
  info "Installing oh-my-zsh..."
  sh -c "$(wget https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -)"
fi
success "oh-my-zsh is g2g"

if [ ! -d "${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions" ]; then
  echo "Installing zsh-autosuggestions..."
  git clone https://github.com/zsh-users/zsh-autosuggestions "${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions"
fi
success "zsh-autosuggestions is g2g"

# Install powerlevel10k theme
pushd "$HOME/.oh-my-zsh/custom" &> /dev/null || error "Couldn't navigate to ~/.oh-my-zsh/custom" && exit
  pushd ./themes &> /dev/null || error "Couldn't navigate to ~/.oh-my-zsh/custom/themes" && exit
    if [ ! -d ./powerlevel10k ]; then
      info "Cloning powerlevel10k..."
      git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ./powerlevel10k
    fi
  popd &> /dev/null || error "Couldn't popd" && exit
popd &> /dev/null || error "Couldn't popd" && exit
success "powerlevel10k is g2g"

# Setup dotfiles
if [ ! -d "$HOME/dotfiles" ]; then
  git clone git@github.com:bweave/dotfiles.git "$HOME/dotfiles"
fi
dotfiles=(eslintrc gitconfig gitignore gitmessage irbrc p10k.zsh tmux.conf tmux.conf.osx zshrc)
for dotfile in $dotfiles; do
  ln -sf "$HOME/dotfiles/$dotfile" "$HOME/.$dotfile"
done

# wezterm conf
mkdir -p "$HOME/.config"
ln -sf "$HOME/dotfiles/wezterm" "$HOME/.config/wezterm"
success "wezterm config g2g"

# Custom bin scripts
mkdir -p "$HOME/bin"
ln -sf "$HOME/dotfiles/tat" "$HOME/bin/tat"
ln -sf "$HOME/dotfiles/git-nuke-staging" "$HOME/bin/git-nuke-staging"

mkdir -p "$HOME/.config/karabiner"
ln -sf "$HOME/dotfiles/karabiner.json" "$HOME/.config/karabiner/karabiner.json"
touch "$HOME/.secrets"

# Install neovim from source
"$HOME/dotfiles/install-neovim-nightly.sh"

# Clone my neovim config
mkdir -p "$HOME/src"
mkdir -p "$HOME/.config/nvim"
if [ ! -d "$HOME/src/nvim-minimal" ]; then
  info "Cloning nvim-minimal config"
  git clone git@github.com:bweave/nvim-minimal.git "$HOME/dotfiles"
fi
ln -sf "$HOME/src/nvim-minimal/init.lua" "$HOME/.config/nvim/init.lua"
ln -sf "$HOME/src/nvim-minimal/lua" "$HOME/.config/nvim/lua"
info "Installing Neovim plugins"
nvim --headless -c 'autocmd User PackerComplete quitall' -c 'PackerSync'

# Setup Hammerspoon
if [ ! -d "$HOME/.hammerspoon" ]; then
  info "cloning Hammerspoon config"
  git clone git@github.com:bweave/hammerspoon-config.git "$HOME/.hammerspoon"
fi
pushd "$HOME/.hammerspoon" &> /dev/null || echo "Couldn't navigate to ~/.hammerspoon" && exit
  git pull
popd &> /dev/null || echo "Couldn't popd" && exit

# Set key repeat rate
sudo defaults write -g InitialKeyRepeat -int 10 # normal minimum is 15 (225 ms)
sudo defaults write -g KeyRepeat -int 1 # normal minimum is 2 (30 ms)
success "fast key repeat set"

# Install ruby
ruby_version="3.0.3"
rbenv install -s $ruby_version
rbenv global $ruby_version
gem install bundler rails
rbenv rehash
success "Ruby $ruby_version installed"

# Setup NVM and Node LTS
info "setting up NVM with Node LTS"
nvm install --lts
nvm alias system node

echo
success =================================================
success "Donezo!"
success =================================================
echo
