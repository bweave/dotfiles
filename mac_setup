#!/bin/bash

RED="\033[0;31m"
GREEN="\033[0;32m"
BLUE="\033[0;34m"
ENDCOLOR="\033[0m"

function msg() {
  echo -e "$1"
}

function info() {
  msg "$BLUE$1$ENDCOLOR"
}

function success() {
  msg "${GREEN}$1${ENDCOLOR}"
}

function error() {
  msg "${RED}$1${ENDCOLOR}"
}

info "Mac setup - enter your password to get started:"
sudo echo "Let's go!"

if [ ! "$(command -v brew)" ]; then
  info "Installing homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi
success "Homebrew is g2g"

info "Install Homebrew packages:"
PS3="Select a Brewfile to install: "
select brewfile in personal work
do
  brew bundle --file "$HOME/dotfiles/Brewfile_$brewfile"
  break
done

if [ ! -d "$HOME/.zsh-autosuggestions" ]; then
  info "Installing zsh-autosuggestions..."
  git clone https://github.com/zsh-users/zsh-autosuggestions "$HOME/.zsh-autosuggestions"
fi
success "zsh-autosuggestions is g2g"

if [ -z "$(pip3 list | grep iterm2)" ]; then
  info "Installing iterm2 python package..."
  pip3 install iterm2
fi
success "iterm2 python package is g2g"

if [ ! -d "$HOME/.config/base16-shell" ]; then
  info "Cloning base16-shell..."
  git clone https://github.com/chriskempson/base16-shell.git "$HOME/.config/base16-shell"
fi
if [ -z "$BASE16_THEME" ]; then
  info "Setting base16_decaf theme..."
  source "$HOME/.config/base16-shell/scripts/base16-decaf.sh"
fi
success "base16-shell is g2g"

if [ ! -d "$HOME/dotfiles" ]; then
  info "Cloning dotfiles..."
  git clone git@github.com:bweave/dotfiles.git "$HOME/dotfiles"
fi
success "dotfiles cloned"

for config in base16-shell-hooks bin_scripts eslint git hammerspoon irb karabiner nvim starship tmux wezterm zsh; do
  info "Symlinking $config..."
  stow --dotfiles -d "$HOME/dotfiles" -t "$HOME" --restow "$config" # --restow forces it
done
success "configs are g2g"

info "Creating .secrets..."
touch "$HOME/.secrets"

info "Installing neovim..."
"$HOME/dotfiles/install-neovim-nightly.sh"

info "Installing Neovim plugins"
nvim --headless -c 'autocmd User PackerComplete quitall' -c 'PackerSync'

sudo defaults write -g InitialKeyRepeat -int 10 # normal minimum is 15 (225 ms)
sudo defaults write -g KeyRepeat -int 1 # normal minimum is 2 (30 ms)
success "fast key repeat set"

ruby_version="3.1.2"
info "Installing ruby v$ruby_version..."
rbenv install -s $ruby_version
rbenv global $ruby_version
eval "$(rbenv init - bash)"
gem install bundler rails
rbenv rehash
success "Ruby $ruby_version installed"

info "setting up NVM with Node LTS"
nvm install --lts
nvm alias system node
success "NVM and Node are g2g"

echo
success =================================================
success "Donezo!"
success =================================================
echo
