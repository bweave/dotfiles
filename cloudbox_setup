#!/usr/bin/bash

sudo apt update
sudo apt dist-upgrade -y

# Install some packages
sudo apt install -y \
  autojump \
  bat \
  exuberant-ctags \
  hub \
  ripgrep \
  silversearcher-ag \
  zsh-autosuggestions

# Check if zsh is intalled and install if needed
if ! command -v zsh; then
  sudo apt install -y zsh
fi

# Set zsh as the default shell from the current user
if [ ! "$SHELL" = "zsh" ]; then
  sudo chsh $(whoami) -s $(which zsh)
fi

# Install oh-my-zsh
if [ ! -d $HOME/.oh-my-zsh ]; then
  sh -c "$(wget https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -)"
fi

if [ ! -d ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions ]; then
  git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
fi

# Install powerlevel10k theme
pushd $HOME/.oh-my-zsh/custom &> /dev/null
  pushd ./themes &> /dev/null
    if [ ! -d ./powerlevel10k ]; then
      git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ./powerlevel10k
    fi
  popd &> /dev/null
popd &> /dev/null

# Setup dotfiles
if [ ! -d $HOME/dotfiles ]; then
  git clone git@github.com:bweave/dotfiles.git $HOME/dotfiles
fi
pushd $HOME/dotfiles &> /dev/null
  for dotfile in eslintrc gitconfig gitignore irbrc p10k.zsh tmux.conf tmux.conf.linux vimrc zshrc; do
    ln -sf $HOME/dotfiles/$dotfile $HOME/.$dotfile
  done
  mkdir -p $HOME/.config/nvim/lua
  ln -sf $HOME/dotfiles/init.lua $HOME/.config/nvim/init.lua
  ln -sf $HOME/dotfiles/nvim/lua/bweave $HOME/.config/nvim/lua/bweave
  ln -sf $HOME/dotfiles/ssh_rc $HOME/.ssh/rc
  ln -sf $HOME/dotfiles/tat /usr/local/bin/tat
  touch $HOME/.secrets
popd &> /dev/null

# Install latest tmux
sudo mv "$(which tmux)" "$(which tmux)_orig"
sudo apt install libevent-dev
curl -s https://api.github.com/repos/tmux/tmux/releases/latest \
  | grep "browser_download_url.*" \
  | cut -d : -f 2,3 \
  | tr -d \" \
  | wget -qi -
tar -zxf tmux-*.tar.gz
cd tmux-*/
./configure --prefix=/usr
make && sudo make install
cd -
rm -rf tmux-*

# instll neovim from snap until v0.5 is available from apt
sudo snap install --beta nvim --classic

# Clone custom nvim themes
if [ ! -d $HOME/src/bweave-nvim ]; then
  mkdir -p $HOME/src
  git clone --depth=1 git@github.com:bweave/bweave-nvim $HOME/src/bweave-nvim
fi
if [ ! -d $HOME/src/nord-light ]; then
  mkdir -p $HOME/src
  git clone --depth=1 git@github.com:bweave/nord-light ${$HOME}/src/nord-light
fi

# manually install fzf to get the most up to date version
if [ ! -d $HOME/.fzf ]; then
  git clone --depth 1 https://github.com/junegunn/fzf.git $HOME/.fzf
  $HOME/.fzf/install --no-update-rc --key-bindings --completion
  exec $SHELL
fi

# Install nvim plugins
nvim --headless -u NONE -c 'lua require("bweave.bootstrap").bootstrap_paq()'

# Install AWS-CLI if needed
pushd /tmp &> /dev/null
  curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
  unzip awscliv2.zip
  sudo ./aws/install
  rm -rf aws
  rm awscliv2.zip
popd &> /dev/null

# Setup forwarding GITHUB_TOKEN env var over ssh
if [ -z ${GITHUB_TOKEN+x} ]; then
  echo GITHUB_TOKEN is not setup. Adding it to ssh config;
  sudo sed -i '/AcceptEnv/ s/$/ GITHUB_TOKEN/' /etc/ssh/sshd_config
  echo Reloading SSH
  sudo service ssh reload
else
  echo "GITHUB_TOKEN is gtg: '$GITHUB_TOKEN'";
fi

echo Done!
echo Be sure to update ~/.secrets
